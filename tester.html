<!-- index.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Test abxrlib-for-webxr.js</title>
  <!-- Include your bundled JS file -->
  <script src="dist/abxrlib-for-webxr.js"></script>
  <script>
    
    // Authentication configuration
    const app_id = 'cf639ac9-7e64-4b02-84bc-ba289aac9525';
    const org_id = '787277ea-f448-4ee7-a84e-637816e83c49';
    const auth_secret = 'ayTBSNwoin2j8eBYzCudzgcj7_XXobUy4weuU3RakgHJTWZX_pzkvJrzglOoJq72';
    //const app_id = '471fd6fd-f5d0-4096-bc0c-17100c1c4fa0';
    //const org_id = '5304ef74-423f-4bd4-87d9-cba4f19c3bdb';
    //const auth_secret = 'vEwWpJs5K2Kib3XeWBhXgQnQr43XNJCSyb5QJoGCU5ec590hFyb63vBSx6dX6Clj';

    const rest_url = 'https://lib-backend.xrdm.app/v1/';
    
    // Track current authentication type and domain
    let currentAuthType = '';
    let currentDomain = '';
    
    // Simple authentication dialog functions
    function showAuthDialog(authMechanism) {
        console.log('showAuthDialog called with:', authMechanism);
        
        const dialog = document.getElementById('authDialog');
        const title = document.getElementById('authTitle');
        const prompt = document.getElementById('authPrompt');
        const input = document.getElementById('authInput');
        
        //console.log('Dialog elements found:', { dialog: !!dialog, title: !!title, prompt: !!prompt, input: !!input });
        
        if (!dialog) {
            console.error('Auth dialog not found!');
            return;
        }
        
        // Extract information from authMechanism
        let promptText = 'Please enter the required authentication information:';
        let inputType = 'text';
        let placeholder = 'Enter value...';
        let domain = '';
        let authType = '';
        
        if (authMechanism && typeof authMechanism.entries === 'function') {
            // Handle AbxrDictStrings
            for (const [key, value] of authMechanism.entries()) {
                if (key === 'prompt') {
                    promptText = value;
                } else if (key === 'type') {
                    authType = value;
                    if (value === 'assessmentPin') {
                        inputType = 'password';
                        placeholder = 'Enter PIN...';
                        title.textContent = 'PIN Required';
                    } else if (value === 'email') {
                        inputType = 'email';
                        placeholder = 'Enter email username';
                        title.textContent = 'Email Authentication Required';
                    }
                } else if (key === 'domain') {
                    domain = value;
                }
            }
        }
        
        // Store current auth type and domain globally
        currentAuthType = authType;
        currentDomain = domain;
        
        prompt.textContent = promptText;
        input.type = inputType;
        input.placeholder = placeholder;
        input.value = '';
        hideAuthError(); // Clear any previous error
        
        // Handle email domain display
        const domainSpan = document.getElementById('authDomain');
        const inputContainer = document.getElementById('authInputContainer');
        
        if (authType === 'email' && domain) {
            // Show domain suffix for email type
            domainSpan.textContent = '@' + domain;
            domainSpan.style.display = 'inline';
            input.style.width = 'auto';
            input.style.flex = '1';
            inputContainer.style.width = '100%';
        } else {
            // Hide domain for other types
            domainSpan.style.display = 'none';
            input.style.width = '100%';
            input.style.flex = 'none';
            inputContainer.style.width = '100%';
        }
        
        dialog.style.display = 'block';
        input.focus();
        //console.log('Dialog should now be visible');
    }
    
    function hideAuthDialog() {
        const dialog = document.getElementById('authDialog');
        if (dialog) {
            dialog.style.display = 'none';
        }
    }
    
    function showAuthError(message) {
        const errorDiv = document.getElementById('authError');
        if (errorDiv) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
    }
    
    function hideAuthError() {
        const errorDiv = document.getElementById('authError');
        if (errorDiv) {
            errorDiv.style.display = 'none';
        }
    }
    
    async function submitAuth() {
        const input = document.getElementById('authInput');
        const value = input.value.trim();
        
        if (!value) {
            showAuthError('Please enter a value');
            return;
        }
        
        try {
            // Construct authentication data based on type
            let authData = {};
            let logValue = value;
            
            if (currentAuthType === 'email') {
                // For email type, combine input with domain
                const fullEmail = currentDomain ? `${value}@${currentDomain}` : value;
                authData = { email: fullEmail };
                logValue = fullEmail;
                console.log('Submitting final authentication with email:', logValue);
            } else if (currentAuthType === 'assessmentPin') {
                // For PIN type, use pin field
                authData = { pin: value };
                console.log('Submitting final authentication with pin:', value);
            } else {
                // Default fallback - use the type as the field name
                authData[currentAuthType || 'value'] = value;
                console.log(`Submitting final authentication with ${currentAuthType || 'value'}:`, value);
            }
            
            // Submit final authentication
            const success = await Abxr.completeFinalAuth(authData);
            
            if (success) {
                hideAuthDialog();
                document.getElementById('simpleInit_result').textContent = 'Authentication complete! Library is ready to use.';
                document.getElementById('simpleInit_result').style.color = 'green';
                
                // Enable buttons
                document.getElementById('eventBtn').disabled = false;
                document.getElementById('logDebugBtn').disabled = false;
                
                console.log('Final authentication successful');
            } else {
                const authTypeLabel = currentAuthType === 'email' ? 'email' : 
                                    currentAuthType === 'assessmentPin' ? 'PIN' : 'credentials';
                showAuthError(`Authentication failed. Please check your ${authTypeLabel} and try again.`);
                input.focus();
                input.select();
            }
        } catch (error) {
            console.error('Authentication error:', error);
            showAuthError('Authentication error: ' + error.message);
        }
    }
    
    // Removed global fetch debugging wrapper - it was interfering with library's internal HTTP requests
    // The library (AbxrLib) should handle all network requests internally without external interference

    // Set up dialog event listeners and initialize form values
    document.addEventListener('DOMContentLoaded', function() {
        
        // Add CORS debugging information
        console.log('üîç CORS DEBUG INFO:', {
            currentOrigin: window.location.origin,
            currentHost: window.location.host,
            currentProtocol: window.location.protocol,
            userAgent: navigator.userAgent.substr(0, 100) + '...'
        });
        
        // Set initial REST URL value
        document.getElementById('rest_url_input').value = rest_url;
        
        // Set up authentication dialog event listeners
        const submitBtn = document.getElementById('authSubmit');
        const cancelBtn = document.getElementById('authCancel');
        const input = document.getElementById('authInput');
        
        if (submitBtn) submitBtn.addEventListener('click', submitAuth);
        if (cancelBtn) cancelBtn.addEventListener('click', hideAuthDialog);
        
        if (input) {
            // Handle Enter key in input
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    submitAuth();
                }
            });
            
            // Clear error when user starts typing
            input.addEventListener('input', function() {
                hideAuthError();
            });
        }
    });

    // Simple One-Step Setup
    async function simpleInit() {
        console.log("Executing Simple One-Step Setup");
        try {
            const restUrl = document.getElementById('rest_url_input').value;
            const appConfig = '<?xml version="1.0" encoding="utf-8" ?><configuration><appSettings><add key="REST_URL" value="' + restUrl + '"/></appSettings></configuration>';
            
            // Use the new simplified API
            console.log('About to call Abxr_init...');
            Abxr_init(app_id, org_id, auth_secret, appConfig);
            console.log('Abxr_init completed, setting debug mode...');
            
            // Enable debug mode - use the global Abxr object
            if (typeof Abxr !== 'undefined') {
                Abxr.setDebugMode(true);
                console.log('Debug mode enabled, setting up setTimeout...');
            }
            
            // Wait a moment for authentication to complete, then check status
            console.log('Setting up setTimeout callback...');
            setTimeout(async () => {
                console.log('setTimeout callback executing...');
                try {
                    console.log('Checking authentication status...');
                    console.log('Abxr.isConfigured():', typeof Abxr !== 'undefined' ? Abxr.isConfigured() : 'Abxr not available');
                    console.log('Abxr.getRequiresFinalAuth():', typeof Abxr !== 'undefined' ? Abxr.getRequiresFinalAuth() : 'Abxr not available');
                    
                    // Check if additional authentication is required first
                    console.log('Checking requiresFinalAuth condition...');
                        if (typeof Abxr !== 'undefined' && Abxr.getRequiresFinalAuth()) {
                            //console.log('RequiresFinalAuth condition met - showing modal');
                            //console.log('Setting result text...');
                            document.getElementById('simpleInit_result').textContent = 'Initial authentication successful, but user authentication required.\n\nAuth Details:\n- App ID: ' + app_id + '\n- Org ID: ' + org_id + '\n- REST URL: ' + restUrl + '\n\nPlease complete the additional authentication when prompted.';
                            document.getElementById('simpleInit_result').style.color = 'orange';
                            //console.log('Result text set, getting authMechanism...');
                            
                            // Show the authentication dialog
                            try {
                                //console.log('Getting authMechanism...');
                                const authMechanism = AbxrLib.AbxrLibInit.get_AuthMechanism();
                                console.log('Showing auth dialog for mechanism:', authMechanism);
                                
                                // First, let's test if the dialog exists
                                //console.log('Looking for dialog element...');
                                const testDialog = document.getElementById('authDialog');
                                //console.log('Dialog element exists:', !!testDialog);
                                if (testDialog) {
                                    //console.log('Making dialog visible directly...');
                                    testDialog.style.display = 'block';
                                    //console.log('Dialog display style set to:', testDialog.style.display);
                                } else {
                                    console.error('Dialog element not found!');
                                }
                                
                                setTimeout(() => {
                                    //console.log('Calling showAuthDialog...');
                                    //console.log('showAuthDialog function exists:', typeof showAuthDialog);
                                    if (typeof showAuthDialog === 'function') {
                                        showAuthDialog(authMechanism);
                                    } else {
                                        //console.error('showAuthDialog function not found!');
                                    }
                                }, 100);
                            } catch (error) {
                                //console.error('Error showing auth dialog:', error);
                            }
                            
                            // Don't enable buttons yet - wait for final auth
                        } else if (typeof Abxr !== 'undefined' && Abxr.isConfigured()) {
                            document.getElementById('simpleInit_result').textContent = 'Authentication successful! Library is ready to use.\n\nAuth Details:\n- App ID: ' + app_id + '\n- Org ID: ' + org_id + '\n- REST URL: ' + restUrl;
                            document.getElementById('simpleInit_result').style.color = 'green';
                            
                            // Enable the shared event and log buttons
                            document.getElementById('eventBtn').disabled = false;
                            document.getElementById('logDebugBtn').disabled = false;
                        } else {
                            document.getElementById('simpleInit_result').textContent = 'Library initialized but authentication may still be in progress. Try the Event/Log buttons below.';
                            document.getElementById('simpleInit_result').style.color = 'orange';
                            
                            // Enable buttons anyway since the library is initialized
                            document.getElementById('eventBtn').disabled = false;
                            document.getElementById('logDebugBtn').disabled = false;
                        }
                } catch (error) {
                    document.getElementById('simpleInit_result').textContent = 'Error checking authentication status: ' + error.message;
                    document.getElementById('simpleInit_result').style.color = 'red';
                }
            }, 1000);
            
        } catch (error) {
            document.getElementById('simpleInit_result').textContent = 'Error: ' + error.message;
            document.getElementById('simpleInit_result').style.color = 'red';
        }
    }



    async function try_Event() {
        console.log("Executing Abxr.Event()");
        try {
            const eventValue = document.getElementById('event_input').value;
            const dictMeta = { verb: "started", assessment_name: eventValue };
            
            // Store the original fetch implementation
            const originalFetch = window.fetch;
            let responseData = undefined;
            
            // Temporarily override fetch to capture the response
            window.fetch = async (...args) => {
                const response = await originalFetch(...args);
                
                // Clone the response so we can read it multiple times
                const clone = response.clone();
                try {
                    const data = await clone.json();
                    responseData = data;
                } catch (e) {
                    responseData = { error: "Could not parse response as JSON" };
                }
                
                return response;
            };
            
            // Use the simplified API
            let result = await Abxr.Event(eventValue, dictMeta);
            
            // Restore original fetch
            window.fetch = originalFetch;
                        
            document.getElementById('event_result').textContent = 
                `Status Code: ${result}\n` +
                `Response: ${JSON.stringify(responseData, null, 2)}`;
                
        } catch (error) {
            document.getElementById('event_result').textContent = 'Error: ' + error.message;
        }
    }

    async function try_logDebug() {
        console.log("Executing Abxr.LogDebug()");
        try {
            const debugValue = document.getElementById('log_input').value;
            
            // Store the original fetch implementation
            const originalFetch = window.fetch;
            let responseData = undefined;
            
            // Temporarily override fetch to capture the response
            window.fetch = async (...args) => {
                const response = await originalFetch(...args);
                
                // Clone the response so we can read it multiple times
                const clone = response.clone();
                try {
                    const data = await clone.json();
                    responseData = data;
                } catch (e) {
                    responseData = { error: "Could not parse response as JSON" };
                }
                
                return response;
            };
            
            // Use the simplified API
            let result = await Abxr.LogDebug(debugValue);
            // Restore original fetch
            window.fetch = originalFetch;
            
            document.getElementById('logDebug_result').textContent = 
                `Status Code: ${result}\n` +
                `Response: ${JSON.stringify(responseData, null, 2)}`;
                
        } catch (error) {
            document.getElementById('logDebug_result').textContent = 'Error: ' + error.message;
        }
    }


  </script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .section {
      margin-bottom: 20px;
      padding: 20px;
      border-radius: 8px;
    }
    
    .simple-section {
      background: #f0f8ff;
      border: 1px solid #b3d9ff;
    }
    
    .shared-section {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      margin-top: 30px;
      }
    
    .action-button {
      width: 150px;
      height: 40px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .action-button:hover {
      background: #0056b3;
    }
    
    .action-button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    
    input[type="text"] {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    
    .result {
      margin-top: 10px;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 4px;
      min-height: 20px;
    }
    
    h1 { 
      color: #333; 
      text-align: center; 
      margin-bottom: 30px;
    }
    
    h2 { 
      color: #555; 
      margin-top: 0; 
    }
  </style>
</head>
<body>
  <!-- Authentication Dialog -->
  <div id="authDialog" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="background: white; margin: 15% auto; padding: 30px; border-radius: 10px; width: 400px; max-width: 90%; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <h2 id="authTitle">Additional Authentication Required</h2>
      <p id="authPrompt">Please enter the required authentication information:</p>
      <div id="authError" style="display: none; color: #dc3545; background-color: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; padding: 10px; margin: 10px 0; font-size: 14px;"></div>
      <div id="authInputContainer" style="display: flex; align-items: center; justify-content: center; margin: 15px 0;">
        <input type="text" id="authInput" style="padding: 12px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px; box-sizing: border-box; flex: 1;" placeholder="Enter value..." />
        <span id="authDomain" style="margin-left: 5px; font-size: 16px; color: #666; display: none;"></span>
      </div>
      <div style="margin-top: 20px;">
        <button id="authSubmit" style="padding: 12px 25px; margin: 0 10px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; background-color: #007bff; color: white;">Submit</button>
        <button id="authCancel" style="padding: 12px 25px; margin: 0 10px; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; background-color: #6c757d; color: white;">Cancel</button>
      </div>
    </div>
  </div>

  <div class="container">
    <h1>Testing abxrlib-for-webxr.js</h1>
    
    <!-- Simple Setup -->
      <div class="section simple-section">
        <h2>Simple One-Step Setup</h2>
        <p>Most users will want to use this approach - initialize and authenticate in one call:</p>
        
        <div style="margin-bottom: 15px;">
          <label for="rest_url_input" style="display: block; margin-bottom: 5px; font-weight: bold;">REST Server URL:</label>
          <input type="text" id="rest_url_input" style="width: 500px;" placeholder="Enter REST server URL">

          <small style="color: #666; display: block; margin-top: 2px;">Make sure your server is running and has proper CORS headers</small>
        </div>
        
        <button onclick="simpleInit()" style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px;">
          Initialize & Authenticate
        </button>
        
        <div id="simpleInit_result" class="result">
          Click the button above to initialize and authenticate in one step
        </div>
        
        <div style="margin-top: 15px; color: #666; font-size: 14px;">
          <p>üí° After successful initialization, use the Event and Log buttons below to send data.</p>
          <p>üîß The library will automatically handle authentication in the background.</p>
        </div>
      </div>

    <!-- Shared Event and Log Section -->
    <div class="section shared-section">
      <h2>üì§ Send Events and Logs</h2>
      <p>Use these buttons to test sending events and debug logs after initialization:</p>
      
      <div style="display: flex; gap: 20px; margin-bottom: 20px;">
        <div style="flex: 1;">
          <label for="event_input" style="display: block; margin-bottom: 5px; font-weight: bold;">Event Name:</label>
          <input type="text" id="event_input" value="Event Testing 123" placeholder="Enter event name">
          <button id="eventBtn" class="action-button" onclick="try_Event()" disabled style="margin-top: 10px;">üì§ Send Event</button>
        </div>
        
        <div style="flex: 1;">
          <label for="log_input" style="display: block; margin-bottom: 5px; font-weight: bold;">Debug Message:</label>
          <input type="text" id="log_input" value="Log Testing 123" placeholder="Enter debug message">
          <button id="logDebugBtn" class="action-button" onclick="try_logDebug()" disabled style="margin-top: 10px;">üìù Send Log Debug</button>
        </div>
      </div>
      
      <div style="display: flex; gap: 20px;">
        <div style="flex: 1;">
          <h3>Event Result:</h3>
          <div id="event_result" class="result">Initialize first to enable</div>
        </div>
        
        <div style="flex: 1;">
          <h3>Log Debug Result:</h3>
          <div id="logDebug_result" class="result">Initialize first to enable</div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
